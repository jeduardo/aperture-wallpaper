name: Build & Publish

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15-intel

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------
      # Brewfile (for bundle)
      # ---------------------------
      - name: Write Brewfile
        run: |
          cat <<'EOF' > Brewfile
          tap "mczachurski/wallpapper"
          brew "node"
          brew "wallpapper"
          cask "brave-browser"
          EOF

      # ---------------------------
      # Install Homebrew + formulae
      # ---------------------------
      - name: Install Homebrew and packages
        shell: bash
        run: |
          # Install Homebrew if missing
          if ! command -v brew >/dev/null 2>&1; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi

          # Set up brew for this shell (Apple Silicon vs Intel)
          if [[ -x "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [[ -x "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
          else
            echo "brew binary not found after installation" >&2
            exit 1
          fi

          brew update-reset || true
          brew bundle --no-upgrade --verbose

      # ---------------------------
      # Node build
      # ---------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install npm dependencies
        run: npm install

      - name: Build
        run: npm run build

      # ---------------------------
      # Delete existing "latest" release
      # ---------------------------
      - name: Delete existing latest release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              const { data: rel } = await github.rest.repos.getReleaseByTag({
                owner, repo, tag: "latest"
              });

              await github.rest.repos.deleteRelease({
                owner, repo,
                release_id: rel.id
              });

              await github.rest.git.deleteRef({
                owner, repo,
                ref: "tags/latest"
              });

              console.log("Deleted previous 'latest' release.");
            } catch (e) {
              console.log("No existing 'latest' release, nothing to delete.");
            }

      # ---------------------------
      # Create new "latest" release
      # ---------------------------
      - name: Create latest release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: latest
          name: Latest build
          draft: false
          prerelease: false
          files: |
            build/**/*.png
            build/**/*.heic

      # ---------------------------
      # Keep only newest release
      # ---------------------------
      - name: Delete older releases
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const keep = parseInt("${{ steps.create_release.outputs.id }}", 10);

            const { data: releases } = await github.rest.repos.listReleases({
              owner, repo,
              per_page: 100
            });

            for (const rel of releases) {
              if (rel.id === keep) continue;

              console.log(`Deleting release id=${rel.id} (${rel.tag_name})`);
              await github.rest.repos.deleteRelease({
                owner, repo,
                release_id: rel.id
              });

              if (rel.tag_name) {
                try {
                  await github.rest.git.deleteRef({
                    owner, repo,
                    ref: `tags/${rel.tag_name}`
                  });
                } catch (err) {
                  console.log(`Failed to delete tag ref ${rel.tag_name}: ${err.message}`);
                }
              }
            }
